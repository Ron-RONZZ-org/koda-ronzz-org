import{r as c,bR as K,aM as te,bP as se,bS as F,aj as M,j as e,aN as ee,ai as _,aW as pe,ap as he,aY as xe,a_ as Y,bT as fe,bU as ae,af as X,ag as H,bV as ge,e as Q,bN as be,B as je}from"./index-Cb1bmBmK.js";import{s as ve,g as q,S as ke,a as we,D as Ne,b as Se}from"./stats-view-_b1cFjiO.js";import{C as _e,a as ye,R as Ce,B as Te}from"./chart-2aLRupgZ.js";import{E as re}from"./empty-indicator-STQxMsTH.js";import{G as Me,C as De,X as Le,Y as Re}from"./gh-chart-BWmTwsXH.js";import{T as Be,a as Ee,K as U,d as E,e as Pe}from"./tabs-CO6vVNPx.js";import{B as Oe,S as W}from"./sort-button-CZTvB1vb.js";import{M as ne}from"./wallet-cards-BZPIYDeM.js";import{S as Ae,a as Ve,b as ze,c as We,d as $e,e as He,f as Ke}from"./select-DjnPV9qj.js";import{M as Fe}from"./lucide-react-BXPXAfiK.js";import{j as Ge,C as le,c as oe,a as Ie,b as Ye,h as Ue}from"./pagemenu-CaoSRAM6.js";import{a as Xe,e as Qe,b as qe,c as $,d as O,f as L}from"./table-BCNL2H8K.js";import{u as Je}from"./newsletters-DuR8KKD7.js";import{e as Ze,f as et,g as tt}from"./stats-Dw3ZL_6y.js";import"./message-square-text-Cl7f2tbO.js";import"./sprout-CrEApBZc.js";import"./_baseAssignValue-DyITDSi7.js";import"./index-D5TMbQVo.js";import"./a-large-small-L2U_wPWJ.js";import"./at-sign-zn6VHHIb.js";import"./copy-Bm8UN6-f.js";import"./hash-Bydeiaa9.js";import"./inbox-Ion97X3-.js";import"./minus-C6PAFjHJ.js";import"./tags-dQNmC1sJ.js";import"./square-BoXJyuwE.js";import"./user-round-check-C27cgk4d.js";import"./repeat-DidFh0Da.js";import"./reply-CSbAYEM2.js";import"./trash-Cud6S0eh.js";const st=({active:a,payload:s})=>{if(!a||!s?.length)return null;const r=s[0].payload,l=r.send_date;return e.jsxs("div",{className:"min-w-[220px] max-w-[240px] rounded-lg border bg-background px-3 py-2 shadow-lg",children:[e.jsxs("div",{className:"mb-2 flex w-full flex-col border-b pb-2",children:[e.jsx("span",{className:"text-sm font-semibold leading-tight",children:r.post_title}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:["Sent on ",ae(l)]})]}),e.jsxs("div",{className:"mb-1 flex w-full justify-between",children:[e.jsx("span",{className:"font-medium text-muted-foreground",children:"Sent"}),e.jsx("div",{className:"ml-2 w-full text-right font-mono",children:M(r.sent_to)})]}),e.jsxs("div",{className:"mb-1 flex w-full justify-between",children:[e.jsx("span",{className:"font-medium text-muted-foreground",children:"Opens"}),e.jsxs("div",{className:"ml-2 w-full text-right font-mono",children:[e.jsxs("span",{className:"text-muted-foreground",children:[M(r.total_opens)," / "]}),_(r.open_rate)]})]}),e.jsxs("div",{className:"mb-1 flex w-full justify-between",children:[e.jsx("span",{className:"font-medium text-muted-foreground",children:"Clicks"}),e.jsxs("div",{className:"ml-2 w-full text-right font-mono",children:[e.jsxs("span",{className:"text-muted-foreground",children:[M(r.total_clicks)," / "]}),_(r.click_rate)]})]})]})},at=({subscribersData:a,avgsData:s,totals:r,isLoading:l,isAvgsLoading:t,initialTab:o="total-subscribers"})=>{const[n,h]=c.useState(o),[p,j]=c.useState(!1),{range:u}=K(),w=te(),[g]=se(),{appSettings:N}=F(),{emailTrackClicks:v,emailTrackOpens:S}=N?.analytics||{},{totalSubscribers:R,avgOpenRate:m,avgClickRate:d}=r,f=c.useMemo(()=>{if(!a||a.length===0)return[];let i=[];return i=ve(a,u,"value","exact"),i.map(D=>({...D,formattedValue:M(D.value),label:"Total Subscribers"}))},[a,u]),y=c.useMemo(()=>{if(!f||f.length<=1)return{direction:"same",value:"0%"};const i=f[0]?.value??0,k=f[f.length-1]?.value??0;let D="same";k>i?D="up":k<i&&(D="down");let P;if(i===0)P=k===0?"0%":"+100%";else{const A=(k-i)/i*100,V=Math.round(A*10)/10;P=`${A>=0?"+":""}${V}%`}return{direction:D,value:P}},[f]);c.useEffect(()=>{h(o)},[o]);const x=i=>{h(i);const k=new URLSearchParams(g);k.set("tab",i),w(`?${k.toString()}`,{replace:!0})},C={open_rate:{label:"Open rate"}},b=c.useMemo(()=>({"total-subscribers":{color:"hsl(var(--chart-darkblue))",datakey:"value"},"avg-open-rate":{color:"hsl(var(--chart-blue))",datakey:"open_rate"},"avg-click-rate":{color:"hsl(var(--chart-teal))",datakey:"click_rate"}}),[]),{barDomain:T,barTicks:B}=c.useMemo(()=>{if(!s||s.length===0||n==="total-subscribers")return{barDomain:[0,1],barTicks:[0,1]};const i=b[n]?.datakey;if(!i)return{barDomain:[0,1],barTicks:[0,1]};const k=s.map(I=>I[i]).filter(I=>typeof I=="number");if(k.length===0)return{barDomain:[0,1],barTicks:[0,1]};const D=Math.min(...k),P=Math.max(...k),A=Math.floor(D*10)/10,V=Math.ceil(P*10)/10,z=Math.max(0,A),Z=V===z?z+.1:V;return{barDomain:[z,Z],barTicks:[z,Z]}},[s,n,b]);if(l)return e.jsx("div",{className:"-mb-6 flex h-[calc(16vw+132px)] w-full items-start justify-center",children:e.jsx(ee,{})});let G="grid-cols-3";(!v||!S)&&(G="grid-cols-2"),!v&&!S&&(G="grid-cols-1");const ue=n==="avg-open-rate"&&m>T[0]&&m<T[1]||n==="avg-click-rate"&&d>T[0]&&d<T[1],J=n==="avg-open-rate"?m:d;return e.jsxs(Be,{defaultValue:o,variant:"kpis",children:[e.jsxs(Ee,{className:`-mx-6 hidden grid-cols-3 md:!visible md:!grid ${G}`,children:[e.jsx(U,{className:`${!S&&!v&&"cursor-auto after:hidden"}`,value:"total-subscribers",onClick:()=>{x("total-subscribers")},children:e.jsx(E,{color:b["total-subscribers"].color,"data-testid":"total-subscribers-value",diffDirection:y.direction,diffValue:y.value,label:"Total subscribers",value:M(R)})}),S&&e.jsx(U,{value:"avg-open-rate",onClick:()=>{x("avg-open-rate")},children:e.jsx(E,{className:t?"opacity-50":"",color:b["avg-open-rate"].color,label:"Avg. open rate",value:_(m)})}),v&&e.jsx(U,{value:"avg-click-rate",onClick:()=>{x("avg-click-rate")},children:e.jsx(E,{className:t?"opacity-50":"",color:b["avg-click-rate"].color,label:"Avg. click rate",value:_(d)})})]}),e.jsxs(pe,{children:[e.jsx(he,{className:"md:hidden",asChild:!0,children:e.jsxs(Pe,{children:[n==="total-subscribers"&&e.jsx(E,{color:b["total-subscribers"].color,label:"Total subscribers",value:M(R)}),n==="avg-open-rate"&&S&&e.jsx(E,{className:t?"opacity-50":"",color:b["avg-open-rate"].color,label:"Avg. open rate",value:_(m)}),n==="avg-click-rate"&&v&&e.jsx(E,{className:t?"opacity-50":"",color:b["avg-click-rate"].color,label:"Avg. click rate",value:_(d)})]})}),e.jsxs(xe,{align:"end",className:"w-56",children:[e.jsx(Y,{onClick:()=>x("total-subscribers"),children:"Total subscribers"}),S&&e.jsx(Y,{onClick:()=>x("avg-open-rate"),children:"Avg. open rate"}),v&&e.jsx(Y,{onClick:()=>x("avg-click-rate"),children:"Avg. click rate"})]})]}),e.jsxs("div",{className:"my-4 [&_.recharts-cartesian-axis-tick-value]:fill-gray-500",children:[n==="total-subscribers"&&e.jsx(Me,{className:"-mb-3 h-[16vw] max-h-[320px] min-h-[180px] w-full",color:b["total-subscribers"].color,data:f,id:"mrr",range:u}),(n==="avg-open-rate"&&S||n==="avg-click-rate"&&v)&&e.jsx(e.Fragment,{children:t?e.jsx("div",{className:"h-[320px] w-full items-center justify-center",children:e.jsx(ee,{})}):s&&s.length>0?e.jsxs(e.Fragment,{children:[e.jsx(_e,{className:"aspect-auto h-[200px] w-full md:h-[220px] xl:h-[320px]",config:C,children:e.jsxs(Oe,{className:p?"!cursor-pointer":"",data:s,margin:{top:20},onClick:i=>{i.activePayload&&i.activePayload[0].payload.post_id&&w(`/posts/analytics/${i.activePayload[0].payload.post_id}`,{crossApp:!0})},onMouseLeave:()=>j(!1),onMouseMove:i=>{j(!!(i.activePayload&&i.activePayload[0].payload.post_id))},children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"barGradient",x1:"0",x2:"0",y1:"0",y2:"1",children:[e.jsx("stop",{offset:"0%",stopColor:b[n].color,stopOpacity:.8}),e.jsx("stop",{offset:"100%",stopColor:b[n].color,stopOpacity:.6})]})}),e.jsx(De,{horizontal:!0,stroke:"hsl(var(--border))",vertical:!1}),e.jsx(Le,{axisLine:{stroke:"hsl(var(--border))",strokeWidth:1},dataKey:"post_id",interval:0,stroke:"hsl(var(--border))",tickFormatter:()=>"",tickLine:!1,tickMargin:10}),e.jsx(Re,{axisLine:!1,domain:T,tickFormatter:i=>_(i),tickLine:!1,ticks:B,width:fe(B,i=>_(i))}),e.jsx(ye,{content:e.jsx(st,{}),cursor:!1,isAnimationActive:!1,position:{y:10}}),ue&&e.jsx(Ce,{label:{value:`${_(J)}`,position:"left",offset:8,fill:"hsl(var(--muted-foreground))"},opacity:.5,stroke:"hsl(var(--muted-foreground))",strokeDasharray:"4 4",y:J}),e.jsx(Te,{activeBar:{fillOpacity:1},dataKey:b[n].datakey,fill:"url(#barGradient)",fillOpacity:.6,isAnimationActive:!1,maxBarSize:32,minPointSize:3,radius:4})]})}),e.jsxs("div",{className:"-mt-4 text-center text-sm text-muted-foreground",children:["Newsletters ",n==="avg-open-rate"?"opens":"clicks"," in this period"]})]}):e.jsx(re,{className:"size-full py-20",title:`No newsletters ${q(u)}`,children:e.jsx(ne,{strokeWidth:1.5})})})]})]})},rt=({newsletters:a})=>{const{selectedNewsletterId:s,setSelectedNewsletterId:r}=K(),l=c.useMemo(()=>a?.filter(t=>t.status==="active")||[],[a]);return c.useEffect(()=>{if(l.length>0&&!s){const t=l.find(o=>o.sort_order===0);r(t?t.id:l[0].id)}},[l,s,r]),l.length<=1?null:e.jsxs(Ae,{value:s||"",onValueChange:t=>{r(t)},children:[e.jsxs(Ve,{className:"w-auto",children:[e.jsx(Fe,{className:"mr-2",size:16,strokeWidth:1.5}),e.jsx(ze,{placeholder:"Select a newsletter"})]}),e.jsx(We,{align:"end",children:e.jsxs($e,{children:[e.jsx(He,{children:"Newsletters"}),l.map(t=>e.jsx(Ke,{value:t.id,children:t.name},t.id))]})})]})},nt=(a,s,r=!0)=>{const l=a??30,{startDate:t,endDate:o}=c.useMemo(()=>X(l),[l]),n=c.useMemo(()=>{const p={date_from:H(t),date_to:H(o)};return s&&(p.newsletter_id=s),p},[t,o,s]),h=Ze({searchParams:n,enabled:r});return r?h:{data:void 0,isLoading:!1,error:null,isError:!1,refetch:h.refetch}},lt=(a,s,r,l=!0)=>{const t=a??30,o=s??"date desc",{startDate:n,endDate:h}=c.useMemo(()=>X(t),[t]),p=c.useMemo(()=>{const u={date_from:H(n),date_to:H(h),order:o};return r&&(u.newsletter_id=r),u},[n,h,o,r]),j=et({searchParams:p,enabled:l});return l?j:{data:void 0,isLoading:!1,error:null,isError:!1,refetch:j.refetch}},ot=(a,s=[],r=!0)=>{const l=c.useMemo(()=>{const o={};return a&&(o.newsletter_id=a),s.length>0&&(o.post_ids=s.join(",")),o},[a,s]),t=tt({searchParams:l,enabled:r});return r?t:{data:void 0,isLoading:!1,error:null,isError:!1,refetch:t.refetch}},ie=(a,s,r,l=!0)=>{const t=lt(a,s,r,l),o=c.useMemo(()=>t.data?.stats?t.data.stats.map(p=>p.post_id):[],[t.data]),n=ot(r,o,l&&o.length>0);return{data:c.useMemo(()=>{if(!t.data?.stats)return;const p=t.data.stats,j=n.data?.stats||[],u=new Map;j.forEach(g=>{u.set(g.post_id,g)});const w=p.map(g=>{const N=u.get(g.post_id);return{...g,total_clicks:N?.total_clicks||0,click_rate:N?.click_rate||0}});return{...t.data,stats:w}},[t.data,n.data]),isLoading:t.isLoading,isClicksLoading:n.isLoading,error:t.error||n.error,isError:t.isError||n.isError,refetch:()=>{t.refetch(),n.refetch()}}},ce=Q.memo(({range:a,selectedNewsletterId:s,shouldFetchStats:r,sortBy:l})=>{const t=te(),{settings:o}=K(),n=String(o.find(m=>m.key==="timezone")?.value||"Etc/UTC"),{data:h,isLoading:p,isClicksLoading:j}=ie(a,l,s||void 0,!!r),{appSettings:u}=F(),{emailTrackClicks:w,emailTrackOpens:g}=u?.analytics||{},N=c.useMemo(()=>h?.stats||[],[h]),v=g&&w?5:g||w?4:3,S=c.useMemo(()=>e.jsx(e.Fragment,{children:e.jsx($,{className:"last:border-none [&>td]:py-2.5",children:e.jsx(L,{className:"font-medium",colSpan:v,children:e.jsx(be,{className:"mt-5"})})})}),[v]),R=c.useMemo(()=>N.length>0?e.jsx(e.Fragment,{children:N.map(m=>e.jsxs($,{className:"last:border-none [&>td]:py-2.5",children:[e.jsx(L,{className:"font-medium",children:e.jsx("div",{className:"group/link inline-flex items-center gap-2",children:m.post_id?e.jsx(je,{className:"h-auto whitespace-normal p-0 text-left hover:!underline",title:"View post analytics",variant:"link",onClick:()=>{t(`/posts/analytics/${m.post_id}/`,{crossApp:!0})},children:m.post_title}):e.jsx(e.Fragment,{children:m.post_title})})}),e.jsx(L,{className:"whitespace-nowrap text-sm",children:ae(m.send_date,n)}),e.jsx(L,{className:"text-right font-mono text-sm",children:M(m.sent_to)}),g&&e.jsxs(L,{className:"text-right font-mono text-sm",children:[e.jsx("span",{className:"group-hover:hidden",children:_(m.open_rate)}),e.jsx("span",{className:"hidden group-hover:!visible group-hover:!block",children:M(m.total_opens)})]}),w&&e.jsx(L,{className:"text-right font-mono text-sm",children:j?e.jsx("span",{className:"inline-block h-4 w-8 animate-pulse rounded bg-gray-200"}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"group-hover:hidden",children:_(m.click_rate)}),e.jsx("span",{className:"hidden group-hover:!visible group-hover:!block",children:M(m.total_clicks)})]})})]},m.post_id))}):e.jsx($,{className:"border-none hover:bg-transparent",children:e.jsx(L,{className:"text-center group-hover:!bg-transparent",colSpan:5,children:e.jsx(re,{className:"size-full py-20",title:`No newsletters ${q(a)}`,children:e.jsx(ne,{strokeWidth:1.5})})})}),[N,j,t,w,g,a]);return p||!h?S:R});ce.displayName="NewsletterTableRows";const de=Q.memo(({sortBy:a,setSortBy:s,range:r})=>{const l=c.useMemo(()=>e.jsxs(Ie,{children:[e.jsx(Ye,{children:"Top newsletters"}),e.jsxs(Ue,{children:[" Your best performing newsletters ",q(r)]})]}),[r]),{appSettings:t}=F(),{emailTrackClicks:o,emailTrackOpens:n}=t?.analytics||{};return e.jsx(qe,{children:e.jsxs($,{children:[e.jsx(O,{className:"min-w-[320px]",variant:"cardhead",children:l}),e.jsx(O,{className:"w-[65px]",children:e.jsx(W,{activeSortBy:a,setSortBy:s,sortBy:"date desc",children:"Date"})}),e.jsx(O,{className:"w-[90px] text-right",children:e.jsx(W,{activeSortBy:a,setSortBy:s,sortBy:"sent_to desc",children:"Sent"})}),n&&e.jsx(O,{className:"w-[90px] text-right",children:e.jsx(W,{activeSortBy:a,setSortBy:s,sortBy:"open_rate desc",children:"Opens"})}),o&&e.jsx(O,{className:"w-[90px] text-right",children:e.jsx(W,{activeSortBy:a,setSortBy:s,sortBy:"click_rate desc",children:"Clicks"})})]})})});de.displayName="NewsletterTableHeader";const me=Q.memo(({range:a,selectedNewsletterId:s,shouldFetchStats:r})=>{const[l,t]=c.useState("open_rate desc");return e.jsx(le,{className:"w-full max-w-[calc(100vw-64px)] overflow-x-auto sidebar:max-w-[calc(100vw-64px-280px)]","data-testid":"top-newsletters-card",children:e.jsx(oe,{children:e.jsxs(Xe,{children:[e.jsx(de,{range:a,setSortBy:t,sortBy:l}),e.jsx(Qe,{children:e.jsx(ce,{range:a,selectedNewsletterId:s,shouldFetchStats:r,sortBy:l})})]})})})});me.displayName="TopNewslettersTable";const Vt=()=>{const{range:a,selectedNewsletterId:s}=K(),[r]=se(),{appSettings:l}=F(),t=r.get("tab")||"total-subscribers",{data:o,isLoading:n}=Je({searchParams:{limit:"50"}}),h=!n&&o&&o.newsletters.length>0&&!!s,{data:p,isLoading:j}=nt(a,s||void 0,h||!1),{data:u,isLoading:w,isClicksLoading:g}=ie(a,"date asc",s||void 0,h||!1),N=c.useMemo(()=>!o?.newsletters||!s?null:o.newsletters.find(d=>d.id===s)||null,[o,s]),v=c.useMemo(()=>{const d=N?.count?.active_members||p?.stats?.[0]?.total||0;let f=0,y=0;if(u?.stats&&u.stats.length>0){const x=u.stats,C=x.reduce((T,B)=>T+(B.open_rate||0),0),b=x.reduce((T,B)=>T+(B.click_rate||0),0);f=C/x.length,y=b/x.length}return{totalSubscribers:d,avgOpenRate:f,avgClickRate:y}},[N,p,u]),S=c.useMemo(()=>{if(!p?.stats?.[0]?.values||p.stats[0].values.length===0){const{startDate:f,endDate:y}=X(a),x=[],C=new Date(f);for(;C<=y;)x.push({date:C.toISOString().split("T")[0],value:0}),C.setDate(C.getDate()+1);return x}const d=p.stats[0].values;if(d.length===1){const f=d[0],y=new Date,x=a,C=new Date(y.getTime()-x*24*60*60*1e3);return[{...f,date:C.toISOString().split("T")[0]},{...f,date:y.toISOString().split("T")[0]}]}return d},[p,a]),R=c.useMemo(()=>u?.stats?u.stats.map(d=>({post_id:d.post_id,post_title:d.post_title,send_date:d.send_date,sent_to:d.sent_to,total_opens:d.total_opens,open_rate:d.open_rate,total_clicks:d.total_clicks||0,click_rate:d.click_rate||0})):[],[u]),m=j||g||w;return l?.newslettersEnabled?e.jsxs(ke,{children:[e.jsx(we,{children:e.jsxs(Ge,{children:[e.jsx(rt,{newsletters:o?.newsletters}),e.jsx(Ne,{})]})}),e.jsx(Se,{isLoading:!1,loadingComponent:e.jsx(e.Fragment,{}),children:e.jsxs(e.Fragment,{children:[e.jsx(le,{"data-testid":"newsletters-card",children:e.jsx(oe,{children:e.jsx(at,{avgsData:R,initialTab:t,isAvgsLoading:!1,isLoading:m,subscribersData:S,totals:v})})}),e.jsx(me,{range:a,selectedNewsletterId:s,shouldFetchStats:!!h})]})})]}):e.jsx(ge,{to:"/"})};export{Vt as default};
