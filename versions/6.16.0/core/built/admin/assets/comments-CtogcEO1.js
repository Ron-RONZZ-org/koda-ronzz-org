import{j as e,y as R,r as c,cU as Q,cV as Z,bQ as $,cz as J,cW as K,B as g,ak as G,ad as I,c2 as ee,cX as se,cY as te,bX as _,bY as D,bZ as T,b_ as P,cy as ae,cJ as ne,aj as E,bz as re,aW as oe,ap as le,aX as ie,aY as ce,a_ as F,x as A,cZ as de,a0 as me,a1 as ue,a2 as he,a3 as pe,a4 as xe,a5 as fe,a6 as ge,a7 as be,D as je,t as ve,v as Ce,w as we,a9 as Ne,aa as ye,bn as ke,bP as Se,aF as _e,f as De,c_ as Te}from"./index-Cb1bmBmK.js";import{F as Pe,c as Fe}from"./filters-stQv1t2Q.js";import{u as Me}from"./posts-BnlRx8vs.js";import{M as ze,c as W,a as Ee,F as $e,e as Re,b as Ie,f as O,D as Le,E as He,g as Ae,C as Oe}from"./message-square-text-Cl7f2tbO.js";import{H as U,g as Ue,u as Ve}from"./use-infinite-virtual-scroll-BzrtTHt0.js";import{M as Be}from"./main-layout-BungCBHk.js";import{R as qe}from"./reply-CSbAYEM2.js";import{E as Qe}from"./empty-indicator-STQxMsTH.js";const We=({children:a,className:t,...s})=>e.jsx("section",{className:R("flex gap-6 flex-col p-4 lg:p-8 size-full grow",t),...s,children:a});function V({knownItems:a,useSearch:t,filters:s,filterFieldName:n,searchFieldName:o,toOption:i}){const[d,l]=c.useState(""),{data:u,isLoading:m}=t(d),p=u?.[o]??[],x=c.useCallback(f=>i(f),[i]);return{options:c.useMemo(()=>{const f={};for(const h of a)f[h.id]=x(h);for(const h of p??[])f[h.id]=x(h);const b=s.find(h=>h.field===n);if(b&&b.values[0]){const h=String(b.values[0]);h in f||(f[h]={value:h,label:`ID: ${h}`})}return Object.values(f)},[a,p,s,n,x]),isLoading:m,searchValue:d,onSearchChange:l}}function Ye(a){const[t]=Q(a,200);return Z({searchParams:{...t&&{search:t},limit:"100",order:"created_at DESC"}})}function Xe(a){const[t]=Q(a,200),s=t?`title:~'${t.replace(/'/g,"\\'")}'`:"";return Me({searchParams:{...s&&{filter:s},limit:"100",fields:"id,title",order:"published_at DESC"}})}const Ze=({knownPosts:a,knownMembers:t,filters:s,onFiltersChange:n})=>{const o=V({knownItems:a,useSearch:Xe,searchFieldName:"posts",filters:s,filterFieldName:"post",toOption:p=>({value:p.id,label:p.title||"(Untitled)"})}),i=V({knownItems:t,useSearch:Ye,searchFieldName:"members",filters:s,filterFieldName:"author",toOption:p=>({value:p.id,label:p.name||"Unknown name",detail:p.email??"(Unknown email)"})}),d=c.useMemo(()=>[{key:"author",label:"Author",type:"select",icon:e.jsx($,{className:"size-4"}),options:i.options,isLoading:i.options.length===0&&i.isLoading,onSearchChange:i.onSearchChange,searchValue:i.searchValue,searchable:!0,className:"w-80",popoverContentClassName:"w-80",operators:[{value:"is",label:"is"},{value:"is_not",label:"is not"}]},{key:"post",label:"Post",type:"select",icon:e.jsx(J,{className:"size-4"}),options:o.options,isLoading:o.options.length===0&&o.isLoading,onSearchChange:o.onSearchChange,searchValue:o.searchValue,searchable:!0,className:"w-80",popoverContentClassName:"w-80",operators:[{value:"is",label:"is"},{value:"is_not",label:"is not"}]},{key:"body",label:"Text",type:"text",icon:e.jsx(ze,{className:"size-4"}),placeholder:"Search comment text...",operators:[{value:"contains",label:"contains"},{value:"not_contains",label:"does not contain"}],defaultOperator:"contains",className:"w-48",popoverContentClassName:"w-48"},{key:"status",label:"Status",type:"select",icon:e.jsx(K,{className:"size-4"}),options:[{value:"published",label:"Published"},{value:"hidden",label:"Hidden"}]},{key:"reported",label:"Reported",type:"select",icon:e.jsx(W,{className:"size-4"}),options:[{value:"true",label:"Yes"},{value:"false",label:"No"}]},{key:"created_at",label:"Date",type:"date",className:"w-32",icon:e.jsx(Ee,{className:"size-4"}),operators:[{value:"is",label:"is"},{value:"before",label:"before"},{value:"after",label:"after"}]}],[o,i]),l=s.length>0,u=c.useCallback(()=>{n([])},[n]),m=R("flex flex-row justify-between",!l&&"[grid-area:actions] ",l&&"col-start-1 col-end-4 row-start-3 pt-7 ");return e.jsxs("div",{className:m,children:[e.jsx(Pe,{addButtonIcon:l?e.jsx($e,{}):e.jsx(Re,{}),addButtonText:l?"Add filter":"Filter",className:`[&>button]:order-last ${l&&"[&>button]:border-none"}`,fields:d,filters:s,keyboardShortcut:"f",popoverAlign:l?"start":"end",onChange:n}),l&&e.jsxs(g,{className:"font-normal text-muted-foreground",variant:"ghost",onClick:u,children:[e.jsx(Ie,{}),"Clear"]})]})},Je=({children:a})=>e.jsxs(U,{className:"!pb-6",variant:"inline-nav",children:[e.jsx(U.Title,{children:"Comments"}),a]}),Ke=({children:a})=>e.jsx(Be,{children:e.jsx("div",{className:"grid w-full grow",children:e.jsx("div",{className:"flex h-full flex-col","data-testid":"comments-page",children:a})})}),Ge="CommentsResponseType",es=G({dataType:Ge,path:"/comments/",defaultNextPageParams:(a,t)=>{var s,n;return(s=a.meta)!=null&&s.pagination.next?{...t,page:(((n=a.meta)==null?void 0:n.pagination.next)||1).toString()}:void 0},returnData:a=>{const{pages:t}=a,s=t.flatMap(o=>o.comments),n=t[t.length-1].meta;return{comments:s,meta:n,isEnd:n?n.pagination.pages===n.pagination.page:!0}}}),ss=a=>es({...a,searchParams:{limit:"100",order:"created_at desc",include:"member,post",...a?.searchParams}}),ts=I({method:"PUT",path:({id:a})=>`/comments/${a}/`,body:({id:a})=>({comments:[{id:a,status:"hidden"}]}),invalidateQueries:{dataType:"CommentsResponseType"}}),as=I({method:"PUT",path:({id:a})=>`/comments/${a}/`,body:({id:a})=>({comments:[{id:a,status:"published"}]}),invalidateQueries:{dataType:"CommentsResponseType"}}),ns=I({method:"PUT",path:({id:a})=>`/comments/${a}/`,body:({id:a})=>({comments:[{id:a,status:"deleted"}]}),invalidateQueries:{dataType:"CommentsResponseType"}}),B=new Map;function rs({parentRef:a,enabled:t=!0,isLoading:s=!1}){const n=ee(),[o,i]=c.useState(null),d=c.useRef(null);c.useEffect(()=>{if(!t||!a.current)return;const l=Ue(a.current);i(l)},[t,a]),c.useEffect(()=>{if(!t||!o)return;const l=n.pathname+n.search,u=()=>{const m=o.scrollTop;B.set(l,m)};return o.addEventListener("scroll",u),()=>o.removeEventListener("scroll",u)},[t,n.pathname,n.search,o]),c.useEffect(()=>{const l=n.pathname+n.search,u=B.get(l);if(!(!t||!o||s)){if(u!==void 0&&d.current!==l){let m=0;const p=3,x=()=>{if(m+=1,!o)return;const f=o.scrollTop,b=o.scrollHeight,h=o.clientHeight,w=b-h;if(u>w&&m<p){setTimeout(x,100);return}if(Math.abs(u-f)>5){const y=Math.min(u,w);o.scrollTop=y}},v=setTimeout(x,150);return()=>clearTimeout(v)}d.current=l}},[t,n.pathname,n.search,o,s])}const q=({height:a})=>e.jsx("div",{"aria-hidden":"true",className:"flex",children:e.jsx("div",{className:"flex",style:{height:a}})}),os=c.forwardRef(function(t,s){return e.jsx("div",{ref:s,...t,"aria-hidden":"true",className:"relative flex flex-col",children:e.jsx("div",{className:"relative z-10 h-24 animate-pulse",children:e.jsx("div",{className:"h-full rounded-md bg-muted","data-testid":"loading-placeholder"})})})});function ls(a){const t=new Date(a);return new Intl.DateTimeFormat("en-US",{month:"short",day:"numeric",year:"numeric",hour:"numeric",minute:"numeric"}).format(t).replace(/(\d+),(\s+\d{4})/,"$1$2")}function is({onClick:a,expanded:t}){return e.jsxs(g,{className:"shrink-0 gap-0.5 self-start p-0 text-base hover:bg-transparent",variant:"ghost",onClick:a,children:[t?"Show less":"Show more",t?e.jsx(Oe,{}):e.jsx(ke,{})]})}function cs({item:a}){const t=c.useRef(null),[s,n]=c.useState(!1),[o,i]=c.useState(!1);return c.useEffect(()=>{const d=()=>{t.current&&n(t.current.scrollHeight>t.current.clientHeight)};return d(),window.addEventListener("resize",d),()=>window.removeEventListener("resize",d)},[a.html]),e.jsx("div",{className:"mt-1 flex flex-col gap-2",children:e.jsxs("div",{className:`flex max-w-[720px] flex-col items-start ${a.status==="hidden"&&"opacity-50"}`,children:[e.jsx("div",{dangerouslySetInnerHTML:{__html:a.html||""},ref:t,className:R("prose flex-1 text-base leading-[1.5em] [&_*]:leading-[1.5em] [&_*]:text-base [&_*]:font-normal [&_blockquote]:border-l-[3px] [&_blockquote]:border-foreground [&_blockquote]:p-0 [&_blockquote]:pl-3 [&_blockquote_p]:mt-0 [&_a]:underline",o?"-mb-1 [&_p]:mb-[0.85em]":"line-clamp-2 [&_p]:m-0 [&_blockquote+p]:mt-1 mb-1")}),s&&e.jsx(is,{expanded:o,onClick:()=>i(!o)})]})})}function ds({items:a,totalItems:t,hasNextPage:s,isFetchingNextPage:n,fetchNextPage:o,onAddFilter:i,isLoading:d,commentPermalinksEnabled:l,disableMemberCommentingEnabled:u}){const m=c.useRef(null);rs({parentRef:m,isLoading:d});const{visibleItems:p,spaceBefore:x,spaceAfter:v}=Ve({items:a,totalItems:t,hasNextPage:s,isFetchingNextPage:n,fetchNextPage:o,parentRef:m}),{mutate:f}=ts(),{mutate:b}=as(),{mutate:h}=ns(),{mutate:w}=se(),{mutate:y}=te(),[k,S]=c.useState(null),[C,N]=c.useState(null),M=()=>{k&&(h({id:k.id}),S(null))},L=()=>{C?.member?.id&&(w({id:C.member.id,reason:`Disabled from comment ${C.commentId}`}),N(null))},z=j=>{j?.id&&y({id:j.id})};return e.jsxs("div",{ref:m,className:"overflow-hidden",children:[e.jsx("div",{className:"flex flex-col","data-testid":"comments-list",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx(q,{height:x}),p.map(({key:j,virtualItem:X,item:r,props:H})=>X.index>a.length-1?e.jsx(os,{...H},j):e.jsxs("div",{...H,className:"grid w-full grid-cols-1 items-start justify-between gap-4 border-b p-3 hover:bg-muted/50 md:p-5 lg:grid-cols-[minmax(0,1fr)_144px]","data-testid":"comment-list-row",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsxs("div",{className:`relative flex size-6 min-w-6 items-center justify-center overflow-hidden rounded-full bg-accent md:size-8 md:min-w-8 ${r.status==="hidden"&&"opacity-50"}`,children:[r.member?.id&&r.member.avatar_image&&e.jsx("div",{className:"absolute inset-0",children:e.jsx("img",{alt:"Member avatar",src:r.member.avatar_image})}),e.jsx("div",{children:e.jsx($,{className:"!size-3 text-muted-foreground md:!size-4",size:12})})]}),e.jsxs("div",{className:"flex min-w-0 flex-col",children:[e.jsxs("div",{className:"flex items-baseline gap-4",children:[e.jsxs("div",{className:`mb-1 flex min-w-0 items-center gap-x-1 text-sm ${r.status==="hidden"&&"opacity-50"}`,children:[e.jsx("div",{className:"whitespace-nowrap",children:r.member?.id?e.jsx(g,{className:"flex h-auto items-center gap-1.5 truncate p-0 font-semibold text-primary hover:opacity-70",variant:"link",onClick:()=>{i("author",r.member.id)},children:r.member.name||"Unknown"}):e.jsx("span",{className:"block truncate font-semibold",children:r.member?.name||"Unknown"})}),u&&r.member?.can_comment===!1&&e.jsx(_,{children:e.jsxs(D,{children:[e.jsx(T,{asChild:!0,children:e.jsx("span",{"data-testid":"commenting-disabled-indicator",children:e.jsx(O,{className:"size-3.5 text-muted-foreground"})})}),e.jsx(P,{children:"Comments disabled"})]})}),e.jsx(Le,{className:"shrink-0 text-muted-foreground/50",size:16}),e.jsx("div",{className:"shrink-0 whitespace-nowrap",children:r.created_at&&e.jsx(_,{children:e.jsxs(D,{children:[e.jsx(T,{asChild:!0,children:e.jsx("span",{className:"cursor-default text-sm text-muted-foreground",children:ae(r.created_at)})}),e.jsx(P,{children:ls(r.created_at)})]})})}),e.jsx("div",{className:"shrink-0 text-muted-foreground",children:"on"}),e.jsx("div",{className:"min-w-0 truncate",children:r.post?.id&&r.post?.title&&i?e.jsx(g,{className:"block h-auto w-full cursor-pointer truncate p-0 text-left font-medium text-gray-800 hover:opacity-70 dark:text-gray-400",variant:"link",onClick:()=>i("post",r.post.id),children:r.post.title}):e.jsx("span",{className:"text-muted-foreground",children:"Unknown post"})})]}),r.status==="hidden"&&e.jsx(ne,{variant:"secondary",children:"Hidden"})]}),e.jsx(cs,{item:r}),e.jsxs("div",{className:"mt-4 flex flex-row flex-nowrap items-center gap-3",children:[r.status==="published"&&e.jsxs(g,{className:"text-gray-800",size:"sm",variant:"outline",onClick:()=>f({id:r.id}),children:[e.jsx(He,{}),"Hide"]}),r.status==="hidden"&&e.jsxs(g,{className:"text-gray-800",size:"sm",variant:"outline",onClick:()=>b({id:r.id}),children:[e.jsx(Ae,{}),"Show"]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(_,{children:e.jsxs(D,{children:[e.jsx(T,{asChild:!0,children:e.jsxs("div",{className:"ml-2 flex items-center gap-1 text-xs text-gray-800",children:[e.jsx(qe,{size:16,strokeWidth:1.5}),e.jsx("span",{children:E(r.count?.replies)})]})}),e.jsx(P,{children:"Replies"})]})}),e.jsx(_,{children:e.jsxs(D,{children:[e.jsx(T,{asChild:!0,children:e.jsxs("div",{className:"ml-2 flex items-center gap-1 text-xs text-gray-800",children:[e.jsx(re,{size:16,strokeWidth:1.5}),e.jsx("span",{children:E(r.count?.likes)})]})}),e.jsx(P,{children:"Likes"})]})}),e.jsx(_,{children:e.jsxs(D,{children:[e.jsx(T,{asChild:!0,children:e.jsxs("div",{className:`ml-2 flex items-center gap-1 text-xs ${r.count?.reports?"font-semibold text-red":"text-gray-800"}`,children:[e.jsx(W,{size:16,strokeWidth:r.count?.reports?1.75:1.5}),e.jsx("span",{children:E(r.count?.reports)})]})}),e.jsx(P,{children:"Reports"})]})})]}),e.jsxs(oe,{children:[e.jsx(le,{asChild:!0,children:e.jsx(g,{className:"relative z-10 ml-1 text-gray-800 hover:bg-secondary [&_svg]:size-4",size:"sm",variant:"ghost",children:e.jsx(ie,{})})}),e.jsxs(ce,{align:"start",children:[l?e.jsx(F,{asChild:!0,children:e.jsxs("a",{href:`${r.post.url}#ghost-comments-${r.id}`,rel:"noopener noreferrer",target:"_blank",children:[e.jsx(A,{className:"mr-2 size-4"}),"View on post"]})}):e.jsx(F,{asChild:!0,children:e.jsxs("a",{href:r.post.url,rel:"noopener noreferrer",target:"_blank",children:[e.jsx(A,{className:"mr-2 size-4"}),"View post"]})}),r.member?.id&&e.jsx(F,{asChild:!0,children:e.jsxs("a",{href:`#/members/${r.member.id}`,children:[e.jsx($,{className:"mr-2 size-4"}),"View member"]})}),u&&r.member?.id&&(r.member.can_comment!==!1?e.jsxs(F,{onClick:()=>{queueMicrotask(()=>N({member:r.member,commentId:r.id}))},children:[e.jsx(O,{className:"mr-2 size-4"}),"Disable commenting"]}):e.jsxs(F,{onClick:()=>z(r.member),children:[e.jsx(de,{className:"mr-2 size-4"}),"Enable commenting"]}))]})]})]})]})]}),e.jsx("div",{children:r.post?.feature_image?e.jsx("img",{alt:r.post.title||"Post feature image",className:`hidden aspect-video w-36 rounded object-cover lg:block ${r.status==="hidden"&&"opacity-50"}`,src:r.post.feature_image}):null})]},j)),e.jsx(q,{height:v})]})}),e.jsx(me,{open:!!k,onOpenChange:j=>!j&&S(null),children:e.jsxs(ue,{children:[e.jsxs(he,{children:[e.jsx(pe,{children:"Delete comment?"}),e.jsx(xe,{children:"This comment will be permanently deleted and cannot be recovered."})]}),e.jsxs(fe,{children:[e.jsx(ge,{children:"Cancel"}),e.jsx(be,{className:"hover:bg-red-700 bg-red-600 text-white",onClick:M,children:"Delete"})]})]})}),e.jsx(je,{open:!!C,onOpenChange:j=>{j||N(null)},children:e.jsxs(ve,{children:[e.jsxs(Ce,{children:[e.jsx(we,{children:"Disable comments"}),e.jsxs(Ne,{children:[C?.member?.name||"This member"," won't be able to comment in the future. You can re-enable commenting anytime."]})]}),e.jsxs(ye,{children:[e.jsx(g,{variant:"outline",onClick:()=>N(null),children:"Cancel"}),e.jsx(g,{onClick:L,children:"Disable comments"})]})]})})]})}const Y=["id","status","created_at","body","post","author","reported"];function ms(a){const t=[];for(const s of a)if(s.values[0])switch(s.field){case"id":t.push(`id:'${s.values[0]}'`);break;case"status":t.push(`status:${s.values[0]}`);break;case"created_at":if(s.operator==="before"&&s.values[0])t.push(`created_at:<'${s.values[0]}'`);else if(s.operator==="after"&&s.values[0])t.push(`created_at:>'${s.values[0]}'`);else if(s.operator==="is"&&s.values[0]){const i=String(s.values[0]),d=new Date(i+"T00:00:00").toISOString(),l=new Date(i+"T23:59:59.999").toISOString();t.push(`created_at:>='${d}'+created_at:<='${l}'`)}break;case"body":const o=s.values[0].replace(/'/g,"\\'");s.operator==="contains"?t.push(`html:~'${o}'`):s.operator==="not_contains"&&t.push(`html:-~'${o}'`);break;case"post":s.operator==="is_not"?t.push(`post_id:-${s.values[0]}`):t.push(`post_id:${s.values[0]}`);break;case"author":s.operator==="is_not"?t.push(`member_id:-${s.values[0]}`):t.push(`member_id:${s.values[0]}`);break;case"reported":s.values[0]==="true"?t.push("count.reports:>0"):s.values[0]==="false"&&t.push("count.reports:0");break}return t.length?t.join("+"):void 0}function us(a){if(!a)return null;const t=a.indexOf(":");return t<=0?null:{operator:a.substring(0,t),value:a.substring(t+1)}}function hs(a){const t=[];for(const s of Y){const n=a.get(s);if(!n)continue;const o=us(n);o&&t.push({id:s,field:s,operator:o.operator,values:[o.value]})}return t}function ps(a){const t=new URLSearchParams;for(const s of a)if(Y.includes(s.field)&&s.values[0]!==void 0){const n=`${s.operator}:${String(s.values[0])}`;t.set(s.field,n)}return t}function xs(){const[a,t]=Se(),s=c.useMemo(()=>hs(a),[a]),n=c.useCallback((l,u={})=>{const m=typeof l=="function"?l(s):l,p=ps(m),x=u.replace??!0;t(p,{replace:x})},[s,t]),o=c.useCallback(({replace:l=!0}={})=>{t(new URLSearchParams,{replace:l})},[t]),i=c.useMemo(()=>ms(s),[s]),d=c.useMemo(()=>s.length===1&&s[0].field==="id",[s]);return{filters:s,nql:i,setFilters:n,clearFilters:o,isSingleIdFilter:d}}function fs({comments:a}){return c.useMemo(()=>{const t=new Map,s=new Map;for(const n of a)n.post?.id&&n.post?.title&&t.set(n.post.id,{id:n.post.id,title:n.post.title}),n.member?.id&&s.set(n.member.id,{id:n.member.id,name:n.member.name,email:n.member.email});return{knownPosts:Array.from(t.values()),knownMembers:Array.from(s.values())}},[a])}const Ss=()=>{const{filters:a,nql:t,setFilters:s,clearFilters:n,isSingleIdFilter:o}=xs(),{data:i}=_e(),d=i?.config?.labs?.commentPermalinks===!0,l=i?.config?.labs?.disableMemberCommenting===!0,u=c.useCallback((S,C,N="is")=>{s(M=>[...M.filter(z=>z.field!==S),Fe(S,N,[C])],{replace:!1})},[s]),{data:m,isError:p,isFetching:x,isFetchingNextPage:v,isRefetching:f,fetchNextPage:b,hasNextPage:h}=ss({searchParams:t?{filter:t}:{},keepPreviousData:!0}),{knownPosts:w,knownMembers:y}=fs({comments:m?.comments??[]}),k=x&&!v&&!f;return e.jsxs(Ke,{children:[e.jsx(Je,{children:!o&&e.jsx(Ze,{filters:a,knownMembers:y,knownPosts:w,onFiltersChange:s})}),e.jsx(We,{children:k?e.jsx("div",{className:"flex h-full items-center justify-center",children:e.jsx(De,{size:"lg"})}):p?e.jsxs("div",{className:"mb-16 flex h-full flex-col items-center justify-center",children:[e.jsx("h2",{className:"mb-2 text-xl font-medium",children:"Error loading comments"}),e.jsx("p",{className:"mb-4 text-muted-foreground",children:"Please reload the page to try again"}),e.jsx(g,{onClick:()=>window.location.reload(),children:"Reload page"})]}):m?.comments.length?e.jsxs(e.Fragment,{children:[e.jsx(ds,{commentPermalinksEnabled:d,disableMemberCommentingEnabled:l,fetchNextPage:b,hasNextPage:h,isFetchingNextPage:v,isLoading:x&&!v,items:m?.comments??[],totalItems:m?.meta?.pagination?.total??0,onAddFilter:u}),o&&e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(g,{variant:"outline",onClick:()=>n({replace:!1}),children:"Show all comments"})})]}):e.jsx("div",{className:"flex h-full items-center justify-center",children:e.jsx(Qe,{title:"No comments yet",children:e.jsx(Te,{})})})})]})};export{Ss as default};
